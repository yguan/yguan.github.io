(function(e,t){var n=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,r=e.IDBKeyRange||e.webkitIDBKeyRange,i={readonly:"readonly",readwrite:"readwrite"},s=Object.prototype.hasOwnProperty;if(!n)throw"IndexedDB required";var o=function(){var e,t=[],n=function(n,r){if(t){r=r||[],e=e||[n,r];for(var i=0,s=t.length;i<s;i++)t[i]&&t[i].apply(e[0],e[1]);t=[]}};this.add=function(){for(var r=0,i=arguments.length;r<i;r++)t.push(arguments[r]);return e&&n(),this},this.execute=function(){return n(this,arguments),this}},u=function(e){var t="progress",n=[["resolve","done",new o,"resolved"],["reject","fail",new o,"rejected"],["notify","progress",new o]],r={},i={state:function(){return t},then:function(){var e=arguments;return u(function(t){n.forEach(function(n,i){var s=e[i];r[n[1]](typeof s=="function"?function(){var e=s.apply(this,arguments);e&&typeof e.promise=="function"&&e.promise().done(t.resolve).fail(t.reject).progress(t.notify)}:t[n[0]])})}).promise()},promise:function(e){return e?(Object.keys(i).forEach(function(t){e[t]=i[t]}),e):i}};return n.forEach(function(e,n){var s=e[2],o=e[3];i[e[1]]=s.add,o&&s.add(function(){t=o}),r[e[0]]=s.execute}),i.promise(r),e&&e.call(r,r),r},a=function(e,t){var n=this,r=!1;this.add=function(t){if(r)throw"Database has been closed";var s=[];for(var o=0;o<arguments.length-1;o++)s[o]=arguments[o+1];var a=e.transaction(t,i.readwrite),f=a.objectStore(t),l=u();return s.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item,t=f.add(e,n)}else t=f.add(e);t.onsuccess=function(t){var n=t.target,r=n.source.keyPath;r===null&&(r="__id__"),Object.defineProperty(e,r,{value:n.result,enumerable:!0}),l.notify()}}),a.oncomplete=function(){l.resolve(s,n)},a.onerror=function(e){l.reject(s,e)},a.onabort=function(e){l.reject(s,e)},l.promise()},this.update=function(t){if(r)throw"Database has been closed";var s=[];for(var o=0;o<arguments.length-1;o++)s[o]=arguments[o+1];var a=e.transaction(t,i.readwrite),f=a.objectStore(t),l=f.keyPath,c=u();return s.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item,t=f.put(e,n)}else t=f.put(e);t.onsuccess=function(e){c.notify()}}),a.oncomplete=function(){c.resolve(s,n)},a.onerror=function(e){c.reject(s,e)},a.onabort=function(e){c.reject(s,e)},c.promise()},this.remove=function(t,n){if(r)throw"Database has been closed";var s=e.transaction(t,i.readwrite),o=s.objectStore(t),a=u(),f=o.delete(n);return s.oncomplete=function(){a.resolve(n)},s.onerror=function(e){a.reject(e)},a.promise()},this.close=function(){if(r)throw"Database has been closed";e.close(),r=!0,delete h[t]},this.get=function(t,n){if(r)throw"Database has been closed";var i=e.transaction(t),s=i.objectStore(t),o=u(),a=s.get(n);return a.onsuccess=function(e){o.resolve(e.target.result)},i.onerror=function(e){o.reject(e)},o.promise()},this.query=function(t,n){if(r)throw"Database has been closed";return new f(t,e,n)};for(var o=0,a=e.objectStoreNames.length;o<a;o++)(function(e){n[e]={};for(var t in n){if(!s.call(n,t)||t==="close")continue;n[e][t]=function(t){return function(){var r=[e].concat([].slice.call(arguments,0));return n[t].apply(n,r)}}(t)}})(e.objectStoreNames[o])},f=function(e,t,n){var i=this,s=function(i,s,o,a){var f=t.transaction(e),l=f.objectStore(e),c=n?l.index(n):l,h=i?r[i].apply(null,s):null,p=[],d=u(),v=[h];return o!=="count"&&v.push(a||"next"),c[o].apply(c,v).onsuccess=function(e){var t=e.target.result;typeof t==typeof 0?p=t:t&&(p.push("value"in t?t.value:t.key),t.continue())},f.oncomplete=function(){d.resolve(p)},f.onerror=function(e){d.reject(e)},f.onabort=function(e){d.reject(e)},d.promise()},o=function(e,t){var n="next",r="openCursor",i=[],o=!1,a=function(){var a=u();return s(e,t,r,o?n+"unique":n).then(function(e){e.constructor===Array&&i.forEach(function(t){if(!t||!t.length)return;t.length===2?e=e.filter(function(e){return e[t[0]]===t[1]}):e=e.filter(t[0])}),a.resolve(e)},a.reject,a.notify),a.promise()},f=function(){return n=null,r="count",{execute:a}},l=function(){return r="openKeyCursor",{desc:h,execute:a,filter:c,distinct:p}},c=function(){return i.push(Array.prototype.slice.call(arguments,0,2)),{keys:l,execute:a,filter:c,desc:h,distinct:p}},h=function(){return n="prev",{keys:l,execute:a,filter:c,distinct:p}},p=function(){return o=!0,{keys:l,count:f,execute:a,filter:c,desc:h}};return{execute:a,count:f,keys:l,filter:c,desc:h,distinct:p}};"only bound upperBound lowerBound".split(" ").forEach(function(e){i[e]=function(){return new o(e,arguments)}}),this.filter=function(){var e=new o(null,null);return e.filter.apply(e,arguments)},this.all=function(){return this.filter()}},l=function(e,t,n){typeof t=="function"&&(t=t());for(var r in t){var i=t[r];if(!s.call(t,r)||n.objectStoreNames.contains(r))continue;var o=n.createObjectStore(r,i.key);for(var u in i.indexes){var a=i.indexes[u];o.createIndex(u,a.key||u,Object.keys(a).length?a:{unique:!1})}}},c=function(e,t,n,r){var i=e.target.result,s=new a(i,t),o,f=u();return f.resolve(s),h[t]=i,f.promise()},h={},p={version:"0.8.0",open:function(e){var t,r=u();return h[e.server]?c({target:{result:h[e.server]}},e.server,e.version,e.schema).done(r.resolve).fail(r.reject).progress(r.notify):(t=n.open(e.server,e.version),t.onsuccess=function(t){c(t,e.server,e.version,e.schema).done(r.resolve).fail(r.reject).progress(r.notify)},t.onupgradeneeded=function(t){l(t,e.schema,t.target.result)},t.onerror=function(e){r.reject(e)}),r.promise()}};typeof define=="function"&&define.amd?define([],function(){return p}):e.db=p})(window);
define(["require","exports","module","data/idb"],function(e,t,n){var r=e("data/idb"),i="tagGroup";n.exports={create:function(e,t){r.create(i,{tags:e},t)},add:function(e,t){this.addTagsToCache(e),r.add(i,{tags:e},"tags",t)},addAll:function(e,t){function o(){r<i?n.add(e[r].tags,{success:function(){++r,o()},failure:function(){s++}}):s===0?t.success():t.failure()}var n=this,r=0,i=e.length,s=0;o()},findAll:function(e,t){var n=function(t){return _.intersection(e,t.tags).length===e.length};r.findAll(i,n,t)},findExact:function(e,t){r.findExact(i,"tags",e,t)},update:function(e,t){r.update(i,e,t)},getAllTags:function(){return Object.keys(this.allTagsCache)},allTagsCache:{},addTagsToCache:function(e){var t=this,n,r;for(n=0,r=e.length;n<r;n++)t.allTagsCache[e[n]]||(t.allTagsCache[e[n]]=!0)},loadAllTagsToCache:function(e,t){if(Object.keys(this.allTagsCache).length===0||t){var n=this;r.each(i,function(e){n.addTagsToCache(e.tags)},e)}},getAll:function(e){r.getAll(i,e)},get:function(e,t){r.get(i,e,t)},remove:function(e,t){r.db[i].remove(e,t)},rename:function(e,t,n){var s=this,o,u,a=s.allTagsCache,f=e.length===1&&t.length===1,l=function(n){_.each(n,function(n){f?n.tags[_.indexOf(n.tags,e[0])]=t[0]:n.tags=[].concat(t,_.difference(n.tags,e))})};f&&delete a[e[0]],_.each(t,function(e){a[e]=!0}),r.findAll(i,function(t){return _.in(e,t.tags)},{success:function(e){l(e),r.updateAll(i,e,n)},failure:n.failure})}}});
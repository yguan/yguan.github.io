define(["require","exports","module","lib/db"],function(e,t,n){var r=e("lib/db"),i={schema:{bookmark:{key:{keyPath:"id",autoIncrement:!0},indexes:{title:{},url:{},dateAdded:{},tagGroupId:{}}},tagGroup:{key:{keyPath:"id",autoIncrement:!0},indexes:{tags:{unique:!0}}}},loadIndexedDB:function(e){var t=this;if(t.db)return;r.open({server:"app-db",version:1,schema:t.schema}).done(function(n){t.db=n,e&&e.success&&e.success(n)}).fail(function(t){e&&e.failure&&e.failure(t)})},db:null,get:function(e,t,n){i.db[e].get(t).done(function(e){n.success(e)}).fail(n.failure)},create:function(e,t,n){i.db[e].add(t).done(function(e){n.success(e[0])}).fail(n.failure)},add:function(e,t,n,r){var i=this;i.findExact(e,n,t[n],{success:function(n){if(n&&n.length>0){var s=n[0];_.extend(s,t),i.update(e,s,{success:function(e){r.success(e[0])},failure:r.failure})}else i.create(e,t,r)},failure:r.failure})},findAll:function(e,t,n){i.db[e].query().filter(t).execute().done(n.success).fail(n.failure)},findAllByKey:function(e,t,n,r){i.db[e].query(t).only(n).execute().done(r.success).fail(r.failure)},findExact:function(e,t,n,r){i.db[e].query(t).only(n).execute().done(r.success).fail(r.failure)},update:function(e,t,n){i.db[e].update(t).done(n.success).fail(n.failure)},each:function(e,t,n){i.db[e].query().filter(function(e){return t(e),!1}).execute().done(n.success).fail(n.failure)},getAll:function(e,t){i.db[e].query().all().execute().done(t.success).fail(t.failure)},"export":function(e){var t=Object.keys(this.schema),n={},r=t.length,s=0,o=function(t,i){n[t]=i,s++,r===s&&e.success(n)};_.each(t,function(t){i.db[t].query().all().execute().done(function(e){o(t,e)}).fail(e.failure)})},updateAll:function(e,t,n){function u(){r<s?o.update(t[r]).done(function(){++r,u()}).fail(n.failure):n.success()}var r=0,s=t.length,o=i.db[e];u()}};n.exports=i});